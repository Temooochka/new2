<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитика финансов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="app_data.js"></script>

    <style>
        /* Общие стили */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
        }

        :root {
            --alfa-red: #EE3124;
            --text-color: #333;
            --light-gray: #f7f7f7;
            --border-color: #ddd;
        }

        .app-screen {
            width: 100%;
            max-width: 390px;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* TOP BAR */
        .top-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 25px 8px 20px;
            font-size: 13px;
            font-weight: 600;
        }

        /* HEADER */
        .header-nav {
            display: flex; /* Обеспечивает выравнивание иконок */
            align-items: center; 
            justify-content: space-between;
            padding: 0 20px;
        }

        .back-title {
            display: flex;
            align-items: center;
            font-size: 18px;
            color: var(--text-color);
            /* Убрал вертикальный padding отсюда, чтобы управлять им для заголовка */
        }
        .back-arrow {
            cursor: pointer;
            margin-right: 15px;
            font-size: 20px;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            padding: 15px 0; /* Вертикальный отступ для заголовка */
        }
        
        /* НОВАЯ ИКОНКА НАСТРОЕК */
        .settings-icon {
            font-size: 20px;
            color: #666;
            cursor: pointer;
            padding: 15px 0;
            margin-left: auto; /* Прижимает к правому краю */
        }

        /* PERIOD SELECTOR */
        .period-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 25px;
            font-size: 15px;
            color: #666;
        }
        .period-selector span {
            margin: 0 10px;
            font-weight: 500;
            color: var(--text-color);
        }
        .period-selector i {
            cursor: pointer;
            font-size: 14px;
        }

        /* TOTAL SUM */
        .total-sum-container {
            padding: 0 20px 25px 20px;
            text-align: center;
        }
        .total-sum-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .total-sum-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--alfa-red);
        }
        
        /* CARDS */
        .content {
            padding: 0 20px 20px 20px;
        }
        
        .analytics-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            padding: 15px 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 10px;
            cursor: pointer;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: var(--text-color);
        }

        .card-header i {
            color: #888;
            font-size: 14px;
        }

        /* FAMILY MEMBERS LIST */
        .family-members-list {
            padding: 5px 0;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-right: 15px;
            /* Цвет фона будет устанавливаться динамически из app_data.js */
        }

        .member-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .member-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }

        .member-role {
            font-size: 13px;
            color: #888;
        }

        .member-spent {
            font-size: 16px;
            font-weight: 600;
            color: var(--alfa-red);
        }
        
        /* CATEGORY LIST */
        .category-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-gray);
        }
        .category-item:last-child {
            border-bottom: none;
        }
        .category-icon {
            font-size: 20px;
            width: 40px;
            text-align: center;
            margin-right: 15px;
        }
        .category-info {
            flex-grow: 1;
        }
        .category-name {
            font-size: 16px;
            font-weight: 500;
        }
        .category-percentage {
            font-size: 13px;
            color: #888;
        }
        .category-spent {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }
    </style>
</head>
<body>

<div class="app-screen">
    
    <div class="top-bar">
        <span>9:41</span>
        <div class="status-icons">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-three-quarters"></i>
        </div>
    </div>

    <header class="header-nav">
        <div class="back-title">
            <i class="fas fa-chevron-left back-arrow" id="navBackToMain"></i>
            <h1 class="header-title">Аналитика финансов</h1>
        </div>
        <i class="fas fa-cog settings-icon" id="navToFamilySettings"></i> 
    </header>

    <div class="period-selector">
        <i class="fas fa-chevron-left" id="prevPeriod"></i>
        <span id="currentPeriod">Ноябрь 2025</span>
        <i class="fas fa-chevron-right" id="nextPeriod"></i>
    </div>

    <div class="total-sum-container">
        <div class="total-sum-label">Всего расходов за период</div>
        <div class="total-sum-value" id="totalExpenseValue">-34 800 ₽</div>
    </div>

    <main class="content">
        
        <div class="analytics-card" id="familyStatsCard">
            <div class="card-header" id="navToFamilyDetail">
                <h2>Анализ по членам семьи</h2>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="family-members-list" id="familyMembersList">
                </div>
        </div>

        <div class="analytics-card" id="categoryStatsCard">
            <div class="card-header" id="navToCategoryDetail">
                <h2>Анализ по категориям</h2>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="category-list" id="categoryList">
                </div>
        </div>
        
        <div class="analytics-card" id="recentTransactionsCard">
            <div class="card-header" id="navToTransactionList">
                <h2>Недавние транзакции</h2>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="transaction-list" id="transactionList">
                </div>
        </div>

    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Mock Dates for the current period (assuming November)
        const START_DATE = '2025-11-01';
        const END_DATE = '2025-11-30';

        // --- Family Stats Rendering ---
        const familyMembersList = document.getElementById('familyMembersList');

        function renderFamilyStats() {
            // Используем обновленную функцию из app_data.js для получения актуальных имен
            const members = getFamilyMembers();
            
            familyMembersList.innerHTML = ''; // Очистка
            
            members.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.classList.add('member-item');
                
                // Используем динамическое имя, инициал и цвет из app_data.js
                memberItem.innerHTML = `
                    <div class="member-icon" style="background-color: ${member.color};">${member.iconInitial}</div>
                    <div class="member-info">
                        <span class="member-name">${member.currentName}</span>
                        <span class="member-role">${member.role}</span>
                    </div>
                    <span class="member-spent">
                        ${getMemberTotalExpense(member.id).toLocaleString('ru-RU')} ₽
                    </span>
                `;
                familyMembersList.appendChild(memberItem);
            });
        }
        
        // --- Category Stats Rendering ---
        const categoryList = document.getElementById('categoryList');

        function renderCategoryStats() {
            // В идеале эта функция должна работать с getFamilyTransactions и агрегировать данные.
            // Для прототипа используем статичные или упрощенные данные.
            const transactions = getFamilyTransactions(START_DATE, END_DATE);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            const categoryAggregates = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    if (!acc[t.categoryId]) {
                        acc[t.categoryId] = {
                            id: t.categoryId,
                            name: t.categoryName,
                            icon: t.categoryIcon,
                            color: t.categoryColor,
                            total: 0
                        };
                    }
                    acc[t.categoryId].total += t.amount;
                    return acc;
                }, {});

            const sortedCategories = Object.values(categoryAggregates).sort((a, b) => b.total - a.total);

            categoryList.innerHTML = '';
            
            sortedCategories.slice(0, 3).forEach(cat => { // Показываем топ-3
                const percentage = totalExpense > 0 ? ((cat.total / totalExpense) * 100).toFixed(1) : 0;
                
                const categoryItem = document.createElement('div');
                categoryItem.classList.add('category-item');
                categoryItem.innerHTML = `
                    <i class="fas ${cat.icon} category-icon" style="color: ${cat.color};"></i>
                    <div class="category-info">
                        <span class="category-name">${cat.name}</span>
                        <span class="category-percentage">${percentage}% от всех трат</span>
                    </div>
                    <span class="category-spent">
                        -${cat.total.toLocaleString('ru-RU')} ₽
                    </span>
                `;
                categoryList.appendChild(categoryItem);
            });
        }
        
        // --- Recent Transactions Rendering ---
        const transactionList = document.getElementById('transactionList');
        
        function renderRecentTransactions() {
            const transactions = getFamilyTransactions(START_DATE, END_DATE);
            
            transactionList.innerHTML = '';
            
            transactions.slice(0, 3).forEach(t => { // Показываем 3 последние транзакции
                if (t.type === 'expense') {
                    const transactionItem = document.createElement('div');
                    transactionItem.classList.add('category-item'); // Переиспользуем стиль
                    
                    const amountText = t.type === 'expense' 
                        ? `<span class="category-spent" style="color: var(--alfa-red);">- ${t.amount.toLocaleString('ru-RU')} ₽</span>`
                        : `<span class="category-spent" style="color: #27AE60;">+ ${t.amount.toLocaleString('ru-RU')} ₽</span>`;

                    transactionItem.innerHTML = `
                        <i class="fas ${t.categoryIcon} category-icon" style="color: ${t.categoryColor};"></i>
                        <div class="category-info">
                            <span class="category-name">${t.description}</span>
                            <span class="category-percentage">${t.memberName} • ${t.categoryName}</span>
                        </div>
                        ${amountText}
                    `;
                    transactionList.appendChild(transactionItem);
                }
            });
        }
        
        // --- Навигация и запуск ---
        
        // Добавлен обработчик для перехода на экран настроек семьи
        document.getElementById('navToFamilySettings').addEventListener('click', () => {
            window.location.href = 'settings_family.html';
        });

        // Заглушки навигации
        document.getElementById('navBackToMain').addEventListener('click', () => alert('Переход на Главный экран'));
        document.getElementById('navToFamilyDetail').addEventListener('click', () => alert('Переход к детальной аналитике по семье'));
        document.getElementById('navToCategoryDetail').addEventListener('click', () => alert('Переход к детальной аналитике по категориям'));
        document.getElementById('navToTransactionList').addEventListener('click', () => alert('Переход к полному списку транзакций'));
        
        // Заглушки смены периода
        document.getElementById('prevPeriod').addEventListener('click', () => alert('Показать предыдущий месяц'));
        document.getElementById('nextPeriod').addEventListener('click', () => alert('Показать следующий месяц'));


        // Вызов функций рендеринга
        renderFamilyStats();
        renderCategoryStats();
        renderRecentTransactions();
    });
</script>
</body>
</html>
