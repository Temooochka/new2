<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки семьи</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // app_data.js (Встроен для простоты)
        const DEFAULT_FAMILY_MEMBERS = [
            { id: 'child', defaultRole: 'Ребенок', currentName: 'Ребенок', roleStatus: 'Зависимый профиль', icon: 'child', editable: true, removable: true },
            { id: 'parent2', defaultRole: 'Мама', currentName: 'Мама', roleStatus: 'Пользователь', icon: 'female', editable: true, removable: false },
            { id: 'parent1', defaultRole: 'Папа', currentName: 'Папа', roleStatus: 'Основной пользователь', icon: 'male', editable: true, removable: false }
        ];

        function getFamilyMembers() {
            try {
                const storedData = localStorage.getItem('familyMembers');
                if (storedData) {
                    return JSON.parse(storedData);
                }
            } catch (e) {
                console.error("Ошибка при чтении localStorage", e);
            }
            saveFamilyMembers(DEFAULT_FAMILY_MEMBERS); // Инициализация
            return DEFAULT_FAMILY_MEMBERS;
        }

        function saveFamilyMembers(members) {
            try {
                localStorage.setItem('familyMembers', JSON.stringify(members));
            } catch (e) {
                console.error("Ошибка при записи в localStorage", e);
            }
        }
    </script>
    <style>
        /* Общие стили для консистентности */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
        }

        :root {
            --alfa-red: #EE3124;
            --alfa-green: #38A34A;
            --text-color: #333;
            --card-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .app-screen {
            width: 100%;
            max-width: 390px;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 25px 8px 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .header-nav {
            padding: 20px;
            background-color: white;
        }

        .back-title {
            display: flex;
            align-items: center;
            padding: 0 0 15px 0;
            font-size: 18px;
            color: var(--text-color);
        }
        .back-arrow {
            cursor: pointer;
            margin-right: 15px;
            font-size: 20px;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .content {
            padding: 0 20px 80px 20px;
        }

        .member-list {
            margin-top: 20px;
        }

        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .member-item:last-of-type {
            border-bottom: none;
        }

        .member-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .member-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .member-icon i {
            font-size: 18px;
            color: white;
        }

        .member-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--text-color);
        }
        .member-details input {
            border: none;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--text-color);
            padding: 0;
            width: 100%;
        }
        .member-details p {
            font-size: 13px;
            color: #888;
            margin: 0;
            margin-top: 2px;
        }

        .icon-male, .icon-female, .icon-dynamic {
            background-color: var(--alfa-red);
        }
        .icon-child {
            background-color: var(--alfa-green);
        }

        .action-button {
            border: none;
            background: none;
            cursor: pointer;
            color: #888;
            font-size: 18px;
            padding: 5px;
            transition: opacity 0.2s;
        }
        .action-button:hover {
            opacity: 0.7;
        }
        
        .add-member-btn {
            width: 100%;
            padding: 15px;
            margin-top: 25px;
            border: none;
            border-radius: 12px;
            background-color: #f0f0f0;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-member-btn i {
            margin-right: 10px;
            font-size: 20px;
        }
        .save-btn {
            background-color: var(--alfa-red);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            width: 100%;
            margin-top: 50px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Bottom Nav (для консистентности) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 390px;
            width: 100%;
            height: 70px;
            background-color: white;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: 5px;
            font-size: 11px;
            color: #888;
            z-index: 20;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }
        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }
        .nav-item.active {
            color: var(--alfa-red);
        }
    </style>
</head>
<body>

<div class="app-screen">
    
    <div class="top-bar">
        <span>9:41</span>
        <div class="status-icons">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-three-quarters"></i>
        </div>
    </div>

    <header class="header-nav">
        <div class="back-title">
            <i class="fas fa-chevron-left back-arrow" id="navToAnalyticsHome"></i>
            <h1 class="header-title">Настройки семьи</h1>
        </div>
    </header>

    <main class="content">

        <div class="member-list" id="memberList">
            </div>

        <button class="add-member-btn" id="addMemberBtn">
            <i class="fas fa-user-plus"></i> Добавить члена семьи
        </button>
        
        <button class="save-btn" onclick="saveChanges()">Сохранить изменения</button>
        
    </main>

    <nav class="bottom-nav">
        <div class="nav-item">
            <i class="fas fa-home"></i>
            <span>Главный</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-credit-card"></i>
            <span>Платежи</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-heart"></i>
            <span>Выгода</span>
        </div>
        <div class="nav-item active">
            <i class="fas fa-history"></i>
            <span>История</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-comment-dots"></i>
            <span>Чаты</span>
        </div>
    </nav>
</div>

<script>
    // Функции getFamilyMembers и saveFamilyMembers доступны из встроенного скрипта выше.
        
    const memberList = document.getElementById('memberList');
    const addMemberBtn = document.getElementById('addMemberBtn');
    const navToAnalyticsHome = document.getElementById('navToAnalyticsHome');

    function renderMemberList() {
        const members = getFamilyMembers();
        memberList.innerHTML = ''; // Очистка перед перерисовкой

        members.forEach(member => {
            const item = document.createElement('div');
            item.className = 'member-item';
            
            const iconFa = member.icon === 'male' ? 'fas fa-male' : 
                           member.icon === 'female' ? 'fas fa-female' : 
                           member.icon === 'child' ? 'fas fa-child' : 
                           'fas fa-user'; // Общая иконка для динамических

            const iconClass = member.id.startsWith('dynamic_') ? 'icon-dynamic' : `icon-${member.icon}`;

            item.innerHTML = `
                <div class="member-info">
                    <div class="member-icon ${iconClass}">
                        <i class="${iconFa}"></i>
                    </div>
                    <div class="member-details">
                        <input type="text" id="name-${member.id}" value="${member.currentName}" maxlength="20" ${member.editable ? '' : 'disabled'}>
                        <p>${member.roleStatus}</p>
                    </div>
                </div>
                <div class="member-actions">
                    ${member.editable ? `<button class="action-button edit-btn" data-id="${member.id}"><i class="fas fa-pencil-alt"></i></button>` : ''}
                    ${member.removable ? `<button class="action-button delete-btn" data-id="${member.id}"><i class="fas fa-trash"></i></button>` : ''}
                </div>
            `;
            memberList.appendChild(item);
        });
    }

    function saveChanges() {
        const members = getFamilyMembers();
        const updatedMembers = members.map(member => {
            const input = document.getElementById(`name-${member.id}`);
            return {
                ...member,
                currentName: input ? input.value.trim() : member.currentName
            };
        });

        saveFamilyMembers(updatedMembers);
        alert('Настройки сохранены! Перейдите на страницу аналитики, чтобы увидеть изменения.');
    }

    addMemberBtn.addEventListener('click', () => {
        const members = getFamilyMembers();
        const dynamicCount = members.filter(m => m.id.startsWith('dynamic_')).length + 1;
        const newMember = {
            id: `dynamic_${Date.now()}`, 
            defaultRole: `Родитель #${dynamicCount}`, 
            currentName: `Родитель #${dynamicCount}`,
            roleStatus: 'Дополнительный профиль',
            icon: 'user', // Общая иконка
            editable: true,
            removable: true
        };
        members.push(newMember);
        saveFamilyMembers(members);
        renderMemberList(); // Перерисовать список после добавления
    });

    memberList.addEventListener('click', (e) => {
        const deleteButton = e.target.closest('.delete-btn');
        if (deleteButton) {
            const memberId = deleteButton.dataset.id;
            if (confirm('Вы уверены, что хотите удалить этого члена семьи?')) {
                let members = getFamilyMembers();
                members = members.filter(m => m.id !== memberId);
                saveFamilyMembers(members);
                renderMemberList();
            }
        }
        // Логика для кнопки "Редактировать" теперь не нужна, так как поле ввода всегда активно.
        // Можно добавить фокус на поле ввода при клике на иконку карандаша, если требуется
    });

    navToAnalyticsHome.addEventListener('click', () => {
        window.location.href = 'analytics_home.html'; 
    });

    // Инициализация
    renderMemberList();
</script>
</body>
</html>
